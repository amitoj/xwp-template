<html>
  <head>
    <script>

      function XHR() {
        if (window.XMLHttpRequest) {
          // IE7+, Firefox, Chrome, Opera, Safari
          return new XMLHttpRequest();
        } else {
          // IE6, IE5
          return new ActiveXObject('Microsoft.XMLHTTP');
        }
      }

      function println(html) {
        var div = document.createElement('div');
        div.innerHTML = html;
        document.getElementsByTagName('body')[0].appendChild(div);
      }

      function echo(xhr,data) {
        var len = 0;
        xhr.onreadystatechange =
          function() {
            if (xhr.readyState == 3 && xhr.status == 200) {
              var chunk = xhr.responseText.substr(len);
              len = len + chunk.length; 
              println(chunk);
            }
            if (xhr.readyState == 4 && xhr.status == 200) {
              println('<hr />');
            }
          }
        xhr.open('POST', '/echo', true);
        xhr.send(data);
      }

      function go() {
        var data = document.getElementById('data').value;
        echo(XHR(), data);
      }

    </script>
  </head>
  <body>

<textarea id="data" rows="8" cols="40">Hello, world!
Line 2
Line 3
One more...
All done!</textarea>

    <button onclick="go()">echo</button>
    <hr />
  </body>
</head>
